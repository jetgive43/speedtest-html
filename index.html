<!DOCTYPE html>
<html lang="en">

<head>
  <title>Example JS</title>
  <meta charset='utf-8'>
  <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/bootstrap@4.3.1/dist/css/bootstrap.min.css"
    integrity="sha384-ggOyR0iXCbMQv3Xipma34MD+dH/1fQ784/j6cY/iJTQUOhcWr7x9JvoRxT2MZw1T" crossorigin="anonymous">
  <script src="https://code.jquery.com/jquery-3.3.1.slim.min.js"
    integrity="sha384-q8i/X+965DzO0rT7abK41JStQIAqVgRVzpbzo5smXKp4YfRvH+8abtTE1Pi6jizo"
    crossorigin="anonymous"></script>
  <script src="https://cdn.jsdelivr.net/npm/popper.js@1.14.7/dist/umd/popper.min.js"
    integrity="sha384-UO2eT0CpHqdSJQ6hJty5KVphtPhzWj9WO1clHTMGa3JDZwrnQq4sF86dIHNDz0W1"
    crossorigin="anonymous"></script>
  <script src="https://cdn.jsdelivr.net/npm/bootstrap@4.3.1/dist/js/bootstrap.min.js"
    integrity="sha384-JjSmVgyd0p3pXB1rRibZUAYoIIy6OrQ6VrjIEaFf/nJGzIxFDsf4x0xIM+B07jRM"
    crossorigin="anonymous"></script>
  <script type="text/javascript" src="http://ajax.googleapis.com/ajax/libs/jquery/3.5.1/jquery.min.js"></script>
</head>

<body>
  <div class="container">
    <h1 class="text-center mt-4">Test Download Time</h1>
    <div class="d-grid">
      <p class="time">0</p>
      <p class="speed">0</p>
      <!-- <p>Your connection speed is:</p> -->

    </div>
  </div>
</body>
<script>
  var speed_array = [];
  var time_array = [];
  function startDownload() {
    $('div.loading').show();
    var startedAt, endedAt;
    // Size in KB
    var size = 1000;
    let avarge_speed = 0;
    let avarge_time = 0;

    startedAt = (new Date().getTime());
    console.log('.....Started.....');
    // window.earlier_entries = window.performance.getEntries().length;
    var settings = { cached: false, datatype: 'html' }
    var time = (new Date().getTime());

    $.when(
      $.ajax('http://195.238.126.147/doc.doc', settings),
    ).done(function (a1) {
      endedAt = new Date().getTime();
      var totalTime = (endedAt - startedAt);
      console.log(totalTime);
      // find_latency();
      var totalsec = totalTime / 1000;
      time_array.push(totalsec);

      var size_mb = (size / 1024 / totalsec);
      var data, identifier, speed;

      if (totalsec > 0) {
        if (size_mb >= 1) {
          data = size_mb;
          identifier = ' MB/s';
        }
        else {
          data = size / totalsec;
          identifier = ' KB/s';
        }
        speed = (data.toFixed(2) + identifier).fixed(2);
        speed_array.push(data.toFixed(2));
      }
      else {
        speed = 'Too fast seem like around certainly >= 8MB/s';
      }
      speed_array.forEach(element => {
        avarge_speed += parseFloat(element) / speed_array.length;
      });
      time_array.forEach(element => {
        avarge_time += parseFloat(element) / time_array.length;
      });
      let result_speed = avarge_speed.toFixed(2) + ' MB/s';
      let result_time = avarge_time.toFixed(2) + ' s';
      $('p.speed').html(result_speed);
      $('p.time').html(result_time);
      $('div.loading').hide();
      $('div.text').show();
    })
  };

  $(document).ready(function () {
    $('div.text').hide();
    (function repeat(number) {
      startDownload(number);
      if (number > 1) repeat(number - 1);
    })(20);
  });
</script>

</html>